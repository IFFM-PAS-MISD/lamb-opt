%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%                     transprop.m                     %%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This function transforms material properties for given stacking direction
% and rotation angle
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function [Cnew] = transprop(C,stack_dir,theta)

theta = theta*pi/180;

if(abs(stack_dir)==1)
    tmparray = [1 2 3];
elseif(abs(stack_dir)==2)
    tmparray = [2 3 1];
else
    tmparray = [3 1 2];
end

if(stack_dir < 0)
    L(tmparray,1) = [0 -cos(theta) -sin(theta)]';
    L(tmparray,2) = [0 -sin(theta) +cos(theta)]';
    L(tmparray,3) = [-1 0 0]';
else
    L(tmparray,1) = [0 cos(theta) sin(theta)]';
    L(tmparray,2) = [0 -sin(theta) +cos(theta)]';
    L(tmparray,3) = [1 0 0]';
end

% R(1,1) = L(1,1)^2;          R(1,2) = L(2,1)^2;          R(1,3) = L(3,1)^2;
% R(1,4) = 2*L(2,1)*L(3,1);   R(1,5) = 2*L(1,1)*L(3,1);   R(1,6) = 2*L(1,1)*L(2,1);
% 
% R(2,1) = L(1,2)^2;          R(2,2) = L(2,2)^2;          R(2,3) = L(3,2)^2;
% R(2,4) = 2*L(2,2)*L(3,2);   R(2,5) = 2*L(1,2)*L(3,2);   R(2,6) = 2*L(1,2)*L(2,2);
% 
% R(3,1) = L(1,3)^2;          R(3,2) = L(2,3)^2;          R(3,3) = L(3,3)^2;
% R(3,4) = 2*L(2,3)*L(3,3);   R(3,5) = 2*L(1,3)*L(3,3);   R(3,6) = 2*L(1,3)*L(2,3);
% 
% R(4,1) = L(1,2)*L(1,3);     R(4,2) = L(2,2)*L(2,3);     R(4,3) = L(3,2)*L(3,3);
% R(4,4) = L(2,2)*L(3,3)+L(2,3)*L(3,2);
% R(4,5) = L(1,2)*L(3,3)+L(1,3)*L(3,2);
% R(4,6) = L(1,2)*L(2,3)+L(1,3)*L(2,2);
% 
% R(5,1) = L(1,1)*L(1,3);     R(5,2) = L(2,1)*L(2,3);     R(5,3) = L(3,1)*L(3,3);
% R(5,4) = L(2,1)*L(3,3)+L(2,3)*L(3,1);
% R(5,5) = L(1,1)*L(3,3)+L(1,3)*L(3,1);
% R(5,6) = L(1,1)*L(2,3)+L(1,3)*L(2,1);
% 
% R(6,1) = L(1,1)*L(1,2);     R(6,2) = L(2,1)*L(2,2);     R(6,3) = L(3,1)*L(3,2);
% R(6,4) = L(2,1)*L(3,2)+L(2,2)*L(3,1);
% R(6,5) = L(1,1)*L(3,2)+L(1,2)*L(3,1);
% R(6,6) = L(1,1)*L(2,2)+L(1,2)*L(2,1);

Q(1,1) = L(1,1)^2;          Q(1,2) = L(2,1)^2;          Q(1,3) = L(3,1)^2;
Q(1,4) = L(2,1)*L(3,1);     Q(1,5) = L(1,1)*L(3,1);     Q(1,6) = L(1,1)*L(2,1);

Q(2,1) = L(1,2)^2;          Q(2,2) = L(2,2)^2;          Q(2,3) = L(3,2)^2;
Q(2,4) = L(2,2)*L(3,2);     Q(2,5) = L(1,2)*L(3,2);     Q(2,6) = L(1,2)*L(2,2);

Q(3,1) = L(1,3)^2;          Q(3,2) = L(2,3)^2;          Q(3,3) = L(3,3)^2;
Q(3,4) = L(2,3)*L(3,3);     Q(3,5) = L(1,3)*L(3,3);     Q(3,6) = L(1,3)*L(2,3);

Q(4,1) = 2*L(1,2)*L(1,3);   Q(4,2) = 2*L(2,2)*L(2,3);   Q(4,3) = 2*L(3,2)*L(3,3);
Q(4,4) = L(2,2)*L(3,3)+L(2,3)*L(3,2);
Q(4,5) = L(1,2)*L(3,3)+L(1,3)*L(3,2);
Q(4,6) = L(1,2)*L(2,3)+L(1,3)*L(2,2);

Q(5,1) = 2*L(1,1)*L(1,3);   Q(5,2) = 2*L(2,1)*L(2,3);   Q(5,3) = 2*L(3,1)*L(3,3);
Q(5,4) = L(2,1)*L(3,3)+L(2,3)*L(3,1);
Q(5,5) = L(1,1)*L(3,3)+L(1,3)*L(3,1);
Q(5,6) = L(1,1)*L(2,3)+L(1,3)*L(2,1);

Q(6,1) = 2*L(1,1)*L(1,2);   Q(6,2) = 2*L(2,1)*L(2,2);   Q(6,3) = 2*L(3,1)*L(3,2);
Q(6,4) = L(2,1)*L(3,2)+L(2,2)*L(3,1);
Q(6,5) = L(1,1)*L(3,2)+L(1,2)*L(3,1);
Q(6,6) = L(1,1)*L(2,2)+L(1,2)*L(2,1);
      
Cnew = Q'*C*Q;

end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%